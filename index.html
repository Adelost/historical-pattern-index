<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPI - Historical Pattern Index</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Design System --- */
        :root {
            --bg-dark: #0b1120;
            --bg-card: rgba(30, 41, 59, 0.65);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-light: rgba(255, 255, 255, 0.08);
            
            /* Tier Colors (Overridden by JS) */
            --tier-color: #38bdf8; 
        }

        /* --- Layout & Reset --- */
        * { box-sizing: border-box; }
        
        body {
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(11, 17, 32, 0.95), rgba(11, 17, 32, 0.9)),
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        main { width: 100%; max-width: 1100px; padding: 2rem 1rem; }

        /* --- Typography --- */
        header { text-align: center; margin-bottom: 3rem; margin-top: 2rem; }
        h1 { font-size: 3rem; margin: 0; letter-spacing: -0.03em; background: linear-gradient(to right, #f1f5f9, #94a3b8); -webkit-background-clip: text; color: transparent; }
        .subtitle { color: var(--text-muted); font-size: 1.1rem; font-weight: 300; margin-top: 0.5rem; }

        /* --- Components --- */
        
        /* Controls */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            margin-bottom: 2rem;
        }

        .filter-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        .control-input {
            background: #0f172a;
            color: var(--text-main);
            border: 1px solid #334155;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }
        .control-input:hover, .control-input:focus { border-color: #38bdf8; }

        .btn-action {
            background: #38bdf8;
            color: #0b1120;
            border: none;
            font-weight: 600;
        }
        .btn-action:hover { filter: brightness(1.1); }

        /* Chart */
        .chart-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            height: 50vh;
            min-height: 400px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px -2px rgba(0,0,0,0.3);
        }

        /* Grid & Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-left: 4px solid var(--tier-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -4px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.15);
        }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 4px 10px;
            border-radius: 100px;
            background: color-mix(in srgb, var(--tier-color), transparent 85%);
            color: var(--tier-color);
            border: 1px solid color-mix(in srgb, var(--tier-color), transparent 70%);
        }

        .card h3 { margin: 0; font-size: 1.25rem; }
        .meta { font-size: 0.85rem; color: var(--text-muted); }

        .metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            padding: 1rem 0;
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
        }

        .metric { font-size: 0.75rem; color: var(--text-muted); }
        .metric b { display: block; font-size: 1.1rem; color: var(--text-main); font-weight: 700; margin-bottom: 2px; }
        
        .note { font-size: 0.9rem; color: #cbd5e1; font-style: italic; line-height: 1.5; }

        footer { margin-top: auto; padding: 3rem; color: var(--text-muted); font-size: 0.9rem; text-align: center; }
        a { color: #38bdf8; text-decoration: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>Historical Pattern Index</h1>
        <div class="subtitle">Quantifying systemic mechanics of mass mortality and cultural erasure.</div>
    </header>

    <main>
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="filter-group">
                <select id="filterPeriod" class="control-input" aria-label="Filter by Period">
                    <option value="all">All Periods</option>
                    <option value="ancient">Ancient (< 500 AD)</option>
                    <option value="colonial">Colonial (1500-1900)</option>
                    <option value="modern">Modern (1900-Present)</option>
                </select>
                <select id="filterTier" class="control-input" aria-label="Filter by Tier">
                    <option value="all">All Tiers</option>
                    <option value="TOTAL ERASURE">Total Erasure</option>
                    <option value="INDUSTRIAL MEGA-EVENT">Industrial Mega-Event</option>
                    <option value="CONTINENTAL COLLAPSE">Continental Collapse</option>
                    <option value="PROFIT-DRIVEN ATTRITION">Profit-Driven Attrition</option>
                </select>
                <select id="filterRegion" class="control-input" aria-label="Filter by Region">
                    <option value="all">All Regions</option>
                    <option value="Europe">Europe</option>
                    <option value="Africa">Africa</option>
                    <option value="Americas">Americas</option>
                    <option value="Asia">Asia</option>
                    <option value="Oceania">Oceania</option>
                </select>
            </div>
            <button id="btnDownload" class="control-input btn-action">⬇ Download Data</button>
        </div>

        <!-- Visualization -->
        <div class="chart-wrapper">
            <canvas id="hpiChart"></canvas>
        </div>

        <!-- Grid -->
        <div id="cardGrid" class="card-grid"></div>
    </main>

    <footer>
        <p>HPI is an open-source project. <a href="https://github.com/adelost/historical-pattern-index">Contribute on GitHub</a>.</p>
        <p>"History without opinions. Just data."</p>
    </footer>

    <script>
        /**
         * HPI Core - v3.5
         * Architecture: Functional, Data-Driven, Component-Based.
         */

        // --- 1. DATA DICTIONARY (Single Source of Truth) ---
        const THEME = {
            tiers: {
                'TOTAL ERASURE': {
                    color: '#ef4444',
                    icon: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/>'
                },
                'INDUSTRIAL MEGA-EVENT': {
                    color: '#f97316',
                    icon: '<path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10z"/>'
                },
                'CONTINENTAL COLLAPSE': {
                    color: '#eab308',
                    icon: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>'
                },
                'PROFIT-DRIVEN ATTRITION': {
                    color: '#a78bfa',
                    icon: '<path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>'
                }
            },
            default: { color: '#94a3b8', icon: '' }
        };

        // --- 2. UTILS (Pure Functions) ---
        const Utils = {
            formatNum: (n) => n ? n.toLocaleString() : '0',
            formatMillions: (n) => n ? (n / 1000000).toFixed(1) + 'M' : '?',
            getTheme: (tierName) => THEME.tiers[tierName] || THEME.default,
            
            // Logic for filtering
            matches: (event, filters) => {
                const { period, tier, region } = filters;
                const { start } = event.period;
                
                if (period === 'ancient' && start > 500) return false;
                if (period === 'colonial' && (start < 1500 || start >= 1900)) return false;
                if (period === 'modern' && start < 1900) return false;
                if (tier !== 'all' && event.analysis.tier !== tier) return false;
                if (region !== 'all' && !event.geography.region.includes(region)) return false;
                
                return true;
            }
        };

        // --- 3. COMPONENTS (HTML Generators) ---
        const Icon = (path) => 
            `<svg style="width:16px; height:16px; fill:currentColor" viewBox="0 0 24 24">${path}</svg>`;

        const Badge = (tierName) => {
            const { icon } = Utils.getTheme(tierName);
            return `<div class="badge">${Icon(icon)} ${tierName}</div>`;
        };

        const Metric = (label, value, sub) => `
            <div class="metric">
                <b>${value}</b>
                ${label}
                ${sub ? `<div style="opacity:0.7">${sub}</div>` : ''}
            </div>`;

        const Card = (event) => {
            const { color } = Utils.getTheme(event.analysis.tier);
            const deaths = event.metrics.mortality;
            const scores = event.metrics.scores;

            return `
            <article class="card" style="--tier-color: ${color}">
                <div class="card-header">
                    <div>
                        <h3>${event.name}</h3>
                        <div class="meta">${event.geography.region} • ${event.period.start}-${event.period.end}</div>
                    </div>
                    ${Badge(event.analysis.tier)}
                </div>

                <div class="metrics-row">
                    ${Metric('Deaths', Utils.formatNum(deaths.max), `Init: ${Utils.formatMillions(deaths.population_initial)}`)}
                    ${Metric('Intensity', scores.systematic_intensity + '%')}
                    ${Metric('Profit', scores.profit + '%')}
                </div>

                <div class="note">"${event.analysis.pattern_note}"</div>
            </article>`;
        };

        // --- 4. APP LOGIC (State & Effects) ---
        const App = {
            state: {
                events: [],
                chart: null,
                filters: { period: 'all', tier: 'all', region: 'all' }
            },

            async init() {
                try {
                    const idx = await fetch('data/index.json').then(r => r.json());
                    const promises = idx.map(url => fetch(url).then(r => r.json()));
                    this.state.events = await Promise.all(promises);
                    
                    this.bindEvents();
                    this.render();
                } catch (e) {
                    console.error("Init failed:", e);
                    document.querySelector('main').innerHTML = `<div class="error-message">Failed to load data. ${e.message}</div>`;
                }
            },

            bindEvents() {
                // Filter Changes
                ['filterPeriod', 'filterTier', 'filterRegion'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        const key = id.replace('filter', '').toLowerCase();
                        this.state.filters[key] = e.target.value;
                        this.render();
                    });
                });

                // Download
                document.getElementById('btnDownload').addEventListener('click', () => {
                    const blob = new Blob([JSON.stringify(this.state.events, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'hpi_dataset.json'; a.click();
                });
            },

            render() {
                const filtered = this.state.events.filter(e => Utils.matches(e, this.state.filters));
                const sorted = [...filtered].sort((a,b) => b.metrics.mortality.max - a.metrics.mortality.max);

                // Update Grid
                const grid = document.getElementById('cardGrid');
                grid.innerHTML = sorted.length ? sorted.map(Card).join('') : '<p style="grid-column:1/-1;text-align:center;color:#64748b">No matching events.</p>';

                // Update Chart
                this.updateChart(sorted);
            },

            updateChart(events) {
                const ctx = document.getElementById('hpiChart').getContext('2d');
                const data = events.map(e => ({
                    x: Math.max(1, e.metrics.mortality.max),
                    y: e.metrics.scores.systematic_intensity,
                    tier: e.analysis.tier, // Custom data
                    raw: e
                }));

                if (this.state.chart) {
                    this.state.chart.data.datasets[0].data = data;
                    this.state.chart.update();
                } else {
                    this.state.chart = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                data: data,
                                backgroundColor: (ctx) => Utils.getTheme(ctx.raw?.tier).color,
                                pointRadius: 8,
                                pointHoverRadius: 12,
                                borderWidth: 1,
                                borderColor: 'rgba(255,255,255,0.3)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#0f172a',
                                    titleColor: '#f1f5f9',
                                    bodyColor: '#cbd5e1',
                                    callbacks: {
                                        label: (c) => c.raw.raw.name,
                                        afterLabel: (c) => [
                                            `Deaths: ${Utils.formatNum(c.raw.raw.metrics.mortality.max)}`,
                                            `Intensity: ${c.raw.y}%`,
                                            `Tier: ${c.raw.tier}`
                                        ]
                                    }
                                }
                            },
                            scales: {
                                x: { type: 'logarithmic', grid: { color: '#334155' }, title: {display:true, text:'Mortality (Log)', color:'#64748b'} },
                                y: { min: 0, max: 105, grid: { color: '#334155' }, title: {display:true, text:'Systematic Intensity (%)', color:'#64748b'} }
                            }
                        }
                    });
                }
            }
        };

        // Boot
        App.init();

    </script>
</body>
</html>