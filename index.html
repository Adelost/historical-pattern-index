<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPI - Historical Pattern Index</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --tier-1: #ef4444;
            --tier-2: #f97316;
            --tier-3: #eab308;
            --tier-4: #8b5cf6;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 2rem 1rem;
            max-width: 800px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 300;
        }

        main {
            width: 100%;
            max-width: 1000px;
            padding: 1rem;
        }

        .chart-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
            height: 60vh;
            min-height: 400px;
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--tier-1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--tier-1);
            margin-bottom: 1rem;
            display: none;
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            align-items: center;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        select {
            background: var(--bg-color);
            color: var(--text-primary);
            border: 1px solid #334155;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-download {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-download:hover {
            opacity: 0.9;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .event-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            transition: transform 0.2s;
        }

        .event-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
        }

        .stats {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stat-item strong {
            color: var(--text-primary);
            display: block;
        }

        .tier-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        footer {
            margin-top: auto;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: center;
        }

        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Corrected Tier Classes */
        .tier-total-erasure { background-color: rgba(239, 68, 68, 0.2); color: var(--tier-1); border-color: var(--tier-1); }
        .tier-industrial-mega-event { background-color: rgba(249, 115, 22, 0.2); color: var(--tier-2); border-color: var(--tier-2); }
        .tier-continental-collapse { background-color: rgba(234, 179, 8, 0.2); color: var(--tier-3); border-color: var(--tier-3); }
        .tier-profit-driven-attrition { background-color: rgba(139, 92, 246, 0.2); color: var(--tier-4); border-color: var(--tier-4); }

    </style>
</head>
<body>

    <header>
        <h1>Historical Pattern Index</h1>
        <div class="subtitle">Quantifying systemic mechanics of mass mortality and cultural erasure.</div>
    </header>

    <main>
        <div id="errorDisplay" class="error-message"></div>
        
        <!-- Controls -->
        <div class="controls-container">
            <div class="filters">
                <select id="filterPeriod" onchange="filterData()">
                    <option value="all">All Periods</option>
                    <option value="ancient">Ancient (< 500 AD)</option>
                    <option value="colonial">Colonial (1500-1900)</option>
                    <option value="modern">Modern (1900-Present)</option>
                </select>
                <select id="filterTier" onchange="filterData()">
                    <option value="all">All Tiers</option>
                    <option value="TOTAL ERASURE">Total Erasure</option>
                    <option value="INDUSTRIAL MEGA-EVENT">Industrial Mega-Event</option>
                    <option value="CONTINENTAL COLLAPSE">Continental Collapse</option>
                    <option value="PROFIT-DRIVEN ATTRITION">Profit-Driven Attrition</option>
                </select>
                <select id="filterRegion" onchange="filterData()">
                    <option value="all">All Regions</option>
                    <option value="Europe">Europe</option>
                    <option value="Africa">Africa</option>
                    <option value="Americas">Americas</option>
                    <option value="Asia">Asia</option>
                    <option value="Oceania">Oceania</option>
                </select>
            </div>
            <button onclick="downloadData()" class="btn-download">⬇ Download JSON</button>
        </div>

        <div class="chart-container">
            <canvas id="hpiChart"></canvas>
        </div>

        <div id="eventList" class="info-grid"></div>
    </main>

    <footer>
        <p>HPI is an open-source project. <a href="https://github.com/adelost/historical-pattern-index">Contribute on GitHub</a>.</p>
        <p>"History without opinions. Just data."</p>
    </footer>

    <script>
        let allEvents = [];
        let chartInstance = null;

        function getSafeClassName(tier) {
            return 'tier-' + tier.toLowerCase().replace(/[\s\.]+/g, '-');
        }

        function getTierColor(tier) {
            const t = tier.toLowerCase();
            if (t.includes('erasure')) return '#ef4444';
            if (t.includes('industrial')) return '#f97316';
            if (t.includes('continental')) return '#eab308';
            return '#8b5cf6';
        }

        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allEvents, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "hpi_dataset.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function filterData() {
            const period = document.getElementById('filterPeriod').value;
            const tier = document.getElementById('filterTier').value;
            const region = document.getElementById('filterRegion').value;

            const filtered = allEvents.filter(e => {
                // Period Filter
                if (period === 'ancient' && e.period.start > 500) return false;
                if (period === 'colonial' && (e.period.start < 1500 || e.period.start >= 1900)) return false;
                if (period === 'modern' && e.period.start < 1900) return false;

                // Tier Filter
                if (tier !== 'all' && e.analysis.tier !== tier) return false;

                // Region Filter (Simple string match)
                if (region !== 'all' && !e.geography.region.includes(region)) return false;

                return true;
            });

            renderDashboard(filtered);
        }

        function renderDashboard(events) {
            // Update Chart
            const chartData = events.map(event => ({
                x: Math.max(1, event.metrics.mortality.max),
                y: event.metrics.scores.systematic_intensity,
                label: event.name,
                tier: event.analysis.tier,
                raw: event
            }));

            if (chartInstance) {
                chartInstance.data.datasets[0].data = chartData;
                chartInstance.update();
            } else {
                const ctx = document.getElementById('hpiChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            data: chartData,
                            backgroundColor: (ctx) => getTierColor(ctx.raw?.tier || ''),
                            pointRadius: 8,
                            pointHoverRadius: 12
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.raw.label,
                                    afterLabel: (ctx) => {
                                        const e = ctx.raw.raw;
                                        return [
                                            `Deaths: ${e.metrics.mortality.max.toLocaleString()}`,
                                            `Intensity: ${e.metrics.scores.systematic_intensity}%`,
                                            `Type: ${e.analysis.tier}`
                                        ];
                                    }
                                }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                type: 'logarithmic',
                                title: { display: true, text: 'Max Mortality (Log Scale)', color: '#94a3b8' },
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            },
                            y: {
                                min: 0, max: 105,
                                title: { display: true, text: 'Systematic Intensity (%)', color: '#94a3b8' },
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }

            // Update Cards
            const listContainer = document.getElementById('eventList');
            listContainer.innerHTML = '';
            
            if (events.length === 0) {
                listContainer.innerHTML = '<p style="color:var(--text-secondary); grid-column: 1/-1; text-align:center;">No events match these filters.</p>';
                return;
            }

            events.sort((a,b) => b.metrics.mortality.max - a.metrics.mortality.max).forEach(event => {
                const card = document.createElement('div');
                const tierClass = getSafeClassName(event.analysis.tier);
                card.className = `event-card ${tierClass}`;
                card.style.borderColor = getTierColor(event.analysis.tier);

                const badge = document.createElement('span');
                badge.className = 'tier-badge';
                badge.textContent = event.analysis.tier;
                badge.style.color = getTierColor(event.analysis.tier);
                badge.style.border = `1px solid ${getTierColor(event.analysis.tier)}`;

                const title = document.createElement('h3');
                title.textContent = event.name;

                const meta = document.createElement('div');
                meta.style.fontSize = '0.85rem';
                meta.style.color = '#94a3b8';
                meta.style.marginBottom = '0.5rem';
                meta.textContent = `${event.geography?.region || 'Unknown'} • ${event.period.start}-${event.period.end}`;

                const stats = document.createElement('div');
                stats.className = 'stats';
                stats.innerHTML = `
                    <div class="stat-item">
                        <strong>${event.metrics.mortality.max.toLocaleString()}</strong>
                        Max Deaths
                        <div style="font-size: 0.7em; color: #64748b;">(Init: ${((event.metrics.mortality.population_initial || 0)/1000000).toFixed(1)}M)</div>
                    </div>
                    <div class="stat-item">
                        <strong>${event.metrics.scores.systematic_intensity}%</strong>
                        Intensity
                    </div>
                    <div class="stat-item">
                        <strong>${event.metrics.scores.profit}%</strong>
                        Profit
                    </div>
                `;

                const note = document.createElement('p');
                note.style.color = '#cbd5e1';
                note.style.fontSize = '0.95rem';
                note.textContent = event.analysis.pattern_note;

                card.appendChild(badge);
                card.appendChild(title);
                card.appendChild(meta);
                card.appendChild(stats);
                card.appendChild(note);
                listContainer.appendChild(card);
            });
        }

        async function init() {
            const errorDisplay = document.getElementById('errorDisplay');
            
            try {
                const indexResponse = await fetch('data/index.json');
                if (!indexResponse.ok) throw new Error('Failed to load data index');
                const fileList = await indexResponse.json();

                for (const file of fileList) {
                    try {
                        const response = await fetch(file);
                        if (!response.ok) throw new Error(`Failed to load ${file}`);
                        allEvents.push(await response.json());
                    } catch (e) {
                        console.error(e);
                    }
                }

                if (allEvents.length === 0) throw new Error('No valid events found');
                
                // Initial Render
                renderDashboard(allEvents);

            } catch (e) {
                errorDisplay.textContent = `Error: ${e.message}`;
                errorDisplay.style.display = 'block';
            }
        }

        init();
    </script>
</body>
</html>