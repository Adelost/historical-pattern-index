<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPI - Historical Pattern Index</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0b1120; /* Darker, richer blue */
            --card-bg: rgba(30, 41, 59, 0.7); /* Semi-transparent */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --tier-1: #f87171;
            --tier-2: #fb923c;
            --tier-3: #facc15;
            --tier-4: #a78bfa;
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)),
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* ... header styles ... */

        .event-card {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .tier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .tier-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
            opacity: 0.8;
        }

        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        footer {
            margin-top: auto;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: center;
        }

        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Corrected Tier Classes */
        .tier-total-erasure { background-color: rgba(239, 68, 68, 0.2); color: var(--tier-1); border-color: var(--tier-1); }
        .tier-industrial-mega-event { background-color: rgba(249, 115, 22, 0.2); color: var(--tier-2); border-color: var(--tier-2); }
        .tier-continental-collapse { background-color: rgba(234, 179, 8, 0.2); color: var(--tier-3); border-color: var(--tier-3); }
        .tier-profit-driven-attrition { background-color: rgba(139, 92, 246, 0.2); color: var(--tier-4); border-color: var(--tier-4); }

    </style>
</head>
<body>

    <header>
        <h1>Historical Pattern Index</h1>
        <div class="subtitle">Quantifying systemic mechanics of mass mortality and cultural erasure.</div>
    </header>

    <main>
        <div id="errorDisplay" class="error-message"></div>
        
        <!-- Controls -->
        <div class="controls-container">
            <div class="filters">
                <select id="filterPeriod" onchange="filterData()">
                    <option value="all">All Periods</option>
                    <option value="ancient">Ancient (< 500 AD)</option>
                    <option value="colonial">Colonial (1500-1900)</option>
                    <option value="modern">Modern (1900-Present)</option>
                </select>
                <select id="filterTier" onchange="filterData()">
                    <option value="all">All Tiers</option>
                    <option value="TOTAL ERASURE">Total Erasure</option>
                    <option value="INDUSTRIAL MEGA-EVENT">Industrial Mega-Event</option>
                    <option value="CONTINENTAL COLLAPSE">Continental Collapse</option>
                    <option value="PROFIT-DRIVEN ATTRITION">Profit-Driven Attrition</option>
                </select>
                <select id="filterRegion" onchange="filterData()">
                    <option value="all">All Regions</option>
                    <option value="Europe">Europe</option>
                    <option value="Africa">Africa</option>
                    <option value="Americas">Americas</option>
                    <option value="Asia">Asia</option>
                    <option value="Oceania">Oceania</option>
                </select>
            </div>
            <button onclick="downloadData()" class="btn-download">⬇ Download JSON</button>
        </div>

        <div class="chart-container">
            <canvas id="hpiChart"></canvas>
        </div>

        <div id="eventList" class="info-grid"></div>
    </main>

    <footer>
        <p>HPI is an open-source project. <a href="https://github.com/adelost/historical-pattern-index">Contribute on GitHub</a>.</p>
        <p>"History without opinions. Just data."</p>
    </footer>

    <script>
        let allEvents = [];
        let chartInstance = null;

        function getSafeClassName(tier) {
            return 'tier-' + tier.toLowerCase().replace(/[\s\.]+/g, '-');
        }

        function getTierColor(tier) {
            const t = tier.toLowerCase();
            if (t.includes('erasure')) return '#ef4444';
            if (t.includes('industrial')) return '#f97316';
            if (t.includes('continental')) return '#eab308';
            return '#8b5cf6';
        }

        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allEvents, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "hpi_dataset.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function filterData() {
            const period = document.getElementById('filterPeriod').value;
            const tier = document.getElementById('filterTier').value;
            const region = document.getElementById('filterRegion').value;

            const filtered = allEvents.filter(e => {
                // Period Filter
                if (period === 'ancient' && e.period.start > 500) return false;
                if (period === 'colonial' && (e.period.start < 1500 || e.period.start >= 1900)) return false;
                if (period === 'modern' && e.period.start < 1900) return false;

                // Tier Filter
                if (tier !== 'all' && e.analysis.tier !== tier) return false;

                // Region Filter (Simple string match)
                if (region !== 'all' && !e.geography.region.includes(region)) return false;

                return true;
            });

            renderDashboard(filtered);
        }

        function renderDashboard(events) {
            // Update Chart
            const chartData = events.map(event => ({
                x: Math.max(1, event.metrics.mortality.max),
                y: event.metrics.scores.systematic_intensity,
                label: event.name,
                tier: event.analysis.tier,
                raw: event
            }));

            if (chartInstance) {
                chartInstance.data.datasets[0].data = chartData;
                chartInstance.update();
            } else {
                const ctx = document.getElementById('hpiChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            data: chartData,
                            backgroundColor: (ctx) => getTierColor(ctx.raw?.tier || ''),
                            pointRadius: 8,
                            pointHoverRadius: 12
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.raw.label,
                                    afterLabel: (ctx) => {
                                        const e = ctx.raw.raw;
                                        return [
                                            `Deaths: ${e.metrics.mortality.max.toLocaleString()}`,
                                            `Intensity: ${e.metrics.scores.systematic_intensity}%`,
                                            `Type: ${e.analysis.tier}`
                                        ];
                                    }
                                }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                type: 'logarithmic',
                                title: { display: true, text: 'Max Mortality (Log Scale)', color: '#94a3b8' },
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            },
                            y: {
                                min: 0, max: 105,
                                title: { display: true, text: 'Systematic Intensity (%)', color: '#94a3b8' },
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }

            // Update Cards
            const listContainer = document.getElementById('eventList');
            listContainer.innerHTML = '';
            
            if (events.length === 0) {
                listContainer.innerHTML = '<p style="color:var(--text-secondary); grid-column: 1/-1; text-align:center;">No events match these filters.</p>';
                return;
            }

        function getTierIcon(tier) {
            const t = tier.toLowerCase();
            // Erasure = Ghost/Dust
            if (t.includes('erasure')) return `<svg class="tier-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>`; 
            // Industrial = Factory/Gear
            if (t.includes('industrial')) return `<svg class="tier-icon" viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2V9h8v10z"/></svg>`;
            // Continental = Globe
            if (t.includes('continental')) return `<svg class="tier-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`;
            // Profit = Coin/Chart
            return `<svg class="tier-icon" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>`;
        }

        // ... existing code ...

                // Render Cards Safely
                events.sort((a,b) => b.metrics.mortality.max - a.metrics.mortality.max).forEach(event => {
                    const card = document.createElement('div');
                    const tierClass = getSafeClassName(event.analysis.tier);
                    card.className = `event-card ${tierClass}`;
                    card.style.borderColor = getTierColor(event.analysis.tier);

                    const header = document.createElement('div');
                    header.className = 'tier-header';

                    const badge = document.createElement('div');
                    badge.className = 'tier-badge';
                    badge.style.color = getTierColor(event.analysis.tier);
                    badge.style.backgroundColor = getTierColor(event.analysis.tier) + '20'; // 20% opacity
                    badge.style.border = `1px solid ${getTierColor(event.analysis.tier)}`;
                    badge.innerHTML = `${getTierIcon(event.analysis.tier)} ${event.analysis.tier}`;

                    header.appendChild(badge);

                    const title = document.createElement('h3');
                    title.textContent = event.name;

                    // ... rest of rendering ...
                    const meta = document.createElement('div');
                    meta.style.fontSize = '0.85rem';
                    meta.style.color = '#94a3b8';
                    meta.style.marginBottom = '0.5rem';
                    meta.textContent = `${event.geography?.region || 'Unknown'} • ${event.period.start}-${event.period.end}`;

                    const stats = document.createElement('div');
                    stats.className = 'stats';
                    stats.innerHTML = `
                        <div class="stat-item">
                            <strong>${event.metrics.mortality.max.toLocaleString()}</strong>
                            Max Deaths
                            <div style="font-size: 0.7em; color: #64748b;">(Init: ${((event.metrics.mortality.population_initial || 0)/1000000).toFixed(1)}M)</div>
                        </div>
                        <div class="stat-item">
                            <strong>${event.metrics.scores.systematic_intensity}%</strong>
                            Intensity
                        </div>
                        <div class="stat-item">
                            <strong>${event.metrics.scores.profit}%</strong>
                            Profit
                        </div>
                    `;

                    const note = document.createElement('p');
                    note.style.color = '#cbd5e1';
                    note.style.fontSize = '0.95rem';
                    note.style.marginTop = '1rem';
                    note.textContent = event.analysis.pattern_note;

                    card.appendChild(header);
                    card.appendChild(title);
                    card.appendChild(meta);
                    card.appendChild(stats);
                    card.appendChild(note);
                    listContainer.appendChild(card);
                });
        }

        async function init() {
            const errorDisplay = document.getElementById('errorDisplay');
            
            try {
                const indexResponse = await fetch('data/index.json');
                if (!indexResponse.ok) throw new Error('Failed to load data index');
                const fileList = await indexResponse.json();

                for (const file of fileList) {
                    try {
                        const response = await fetch(file);
                        if (!response.ok) throw new Error(`Failed to load ${file}`);
                        allEvents.push(await response.json());
                    } catch (e) {
                        console.error(e);
                    }
                }

                if (allEvents.length === 0) throw new Error('No valid events found');
                
                // Initial Render
                renderDashboard(allEvents);

            } catch (e) {
                errorDisplay.textContent = `Error: ${e.message}`;
                errorDisplay.style.display = 'block';
            }
        }

        init();
    </script>
</body>
</html>