<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPI - Historical Pattern Index</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0b1120;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            /* Semantic Tier Colors */
            --color-erasure: #ef4444;
            --color-industrial: #f97316;
            --color-continental: #eab308;
            --color-profit: #a78bfa;
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)),
                linear-gradient(#1e293b 1px, transparent 1px),
                linear-gradient(90deg, #1e293b 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 3rem 1rem 2rem;
            max-width: 800px;
        }

        h1 { font-size: 2.5rem; margin: 0 0 0.5rem; letter-spacing: -1px; }
        .subtitle { color: var(--text-secondary); font-size: 1.1rem; font-weight: 300; }

        main { width: 100%; max-width: 1000px; padding: 1rem; }

        /* Controls & Filters */
        .controls-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .filters { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        select, .btn-download {
            background: #1e293b;
            color: var(--text-primary);
            border: 1px solid #334155;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover, .btn-download:hover { border-color: var(--accent); }
        .btn-download { background: var(--accent); color: #0f172a; font-weight: 600; border: none; }

        /* Chart */
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
            height: 50vh;
            min-height: 400px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Event Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            padding-bottom: 3rem;
        }

        .event-card {
            /* Dynamic variable set by JS */
            --card-theme: var(--accent); 
            
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--card-theme);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }

        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        
        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--card-theme);
            background: color-mix(in srgb, var(--card-theme), transparent 85%);
            border: 1px solid color-mix(in srgb, var(--card-theme), transparent 60%);
        }

        .tier-icon { width: 16px; height: 16px; fill: currentColor; }

        h3 { margin: 0; font-size: 1.25rem; line-height: 1.3; }
        .meta { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .stat-item { font-size: 0.8rem; color: var(--text-secondary); }
        .stat-value { display: block; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .stat-sub { font-size: 0.7em; opacity: 0.7; }

        .pattern-note { font-size: 0.9rem; color: #cbd5e1; line-height: 1.5; font-style: italic; }

        .error-message { display: none; color: var(--color-erasure); background: rgba(239,68,68,0.1); padding: 1rem; border-radius: 8px; text-align: center; }
        
        footer { margin-top: auto; padding: 2rem; color: var(--text-secondary); font-size: 0.9rem; text-align: center; }
        a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>

    <header>
        <h1>Historical Pattern Index</h1>
        <div class="subtitle">Quantifying systemic mechanics of mass mortality and cultural erasure.</div>
    </header>

    <main>
        <div id="errorDisplay" class="error-message"></div>
        
        <div class="controls-container">
            <div class="filters">
                <select id="filterPeriod">
                    <option value="all">All Periods</option>
                    <option value="ancient">Ancient (< 500 AD)</option>
                    <option value="colonial">Colonial (1500-1900)</option>
                    <option value="modern">Modern (1900-Present)</option>
                </select>
                <select id="filterTier">
                    <option value="all">All Tiers</option>
                    <option value="TOTAL ERASURE">Total Erasure</option>
                    <option value="INDUSTRIAL MEGA-EVENT">Industrial Mega-Event</option>
                    <option value="CONTINENTAL COLLAPSE">Continental Collapse</option>
                    <option value="PROFIT-DRIVEN ATTRITION">Profit-Driven Attrition</option>
                </select>
                <select id="filterRegion">
                    <option value="all">All Regions</option>
                    <option value="Europe">Europe</option>
                    <option value="Africa">Africa</option>
                    <option value="Americas">Americas</option>
                    <option value="Asia">Asia</option>
                    <option value="Oceania">Oceania</option>
                </select>
            </div>
            <button id="btnDownload" class="btn-download">⬇ JSON</button>
        </div>

        <div class="chart-container">
            <canvas id="hpiChart"></canvas>
        </div>

        <div id="eventList" class="info-grid"></div>
    </main>

    <footer>
        <p>HPI is an open-source project. <a href="https://github.com/adelost/historical-pattern-index">Contribute on GitHub</a>.</p>
        <p>"History without opinions. Just data."</p>
    </footer>

    <script>
        /**
         * HPI Client Application
         * A declarative, functional approach to rendering historical data.
         */

        // --- Configuration & Constants ---
        const CONFIG = {
            selectors: {
                list: '#eventList',
                chart: '#hpiChart',
                error: '#errorDisplay',
                filters: {
                    period: '#filterPeriod',
                    tier: '#filterTier',
                    region: '#filterRegion'
                },
                download: '#btnDownload'
            },
            colors: {
                erasure: '#ef4444',
                industrial: '#f97316',
                continental: '#eab308',
                profit: '#a78bfa',
                default: '#38bdf8'
            }
        };

        // --- State Management ---
        let appState = {
            events: [],
            chart: null
        };

        // --- Pure Helper Functions ---
        const formatNumber = (num) => num ? num.toLocaleString() : '0';
        const formatMillions = (num) => num ? (num / 1000000).toFixed(1) + 'M' : 'N/A';

        const getTierColor = (tier) => {
            const t = tier.toLowerCase();
            if (t.includes('erasure')) return CONFIG.colors.erasure;
            if (t.includes('industrial')) return CONFIG.colors.industrial;
            if (t.includes('continental')) return CONFIG.colors.continental;
            return CONFIG.colors.profit;
        };

        // --- Components (Template Functions) ---
        // Returns SVG string based on tier
        const TierIcon = (tier) => {
            const t = tier.toLowerCase();
            let path = '';
            
            if (t.includes('erasure')) path = 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z'; // Ghost/Warning
            else if (t.includes('industrial')) path = 'M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2V9h8v10z'; // Factory
            else if (t.includes('continental')) path = 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'; // Globe
            else path = 'M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z'; // Profit

            return `<svg class="tier-icon" viewBox="0 0 24 24"><path d="${path}"/></svg>`;
        };

        const StatItem = (value, label, subtext = '') => `
            <div class="stat-item">
                <span class="stat-value">${value}</span>
                ${label}
                ${subtext ? `<div class="stat-sub">${subtext}</div>` : ''}
            </div>
        `;

        const EventCard = (event) => {
            const themeColor = getTierColor(event.analysis.tier);
            const initPop = event.metrics.mortality.population_initial;
            
            return `
            <div class="event-card" style="--card-theme: ${themeColor}">
                <div class="card-header">
                    <div>
                        <h3>${event.name}</h3>
                        <div class="meta">${event.geography?.region || 'Unknown'} • ${event.period.start}-${event.period.end}</div>
                    </div>
                    <div class="tier-badge">
                        ${TierIcon(event.analysis.tier)}
                        ${event.analysis.tier}
                    </div>
                </div>

                <div class="stats-grid">
                    ${StatItem(formatNumber(event.metrics.mortality.max), 'Max Deaths', `Init: ${formatMillions(initPop)}`)}
                    ${StatItem(event.metrics.scores.systematic_intensity + '%', 'Intensity')}
                    ${StatItem(event.metrics.scores.profit + '%', 'Profit Score')}
                </div>

                <div class="pattern-note">
                    "${event.analysis.pattern_note}"
                </div>
            </div>`;
        };

        // --- Core Logic ---

        const fetchEvents = async () => {
            const indexRes = await fetch('data/index.json');
            const files = await indexRes.json();
            const promises = files.map(file => fetch(file).then(r => r.json()));
            return Promise.all(promises);
        };

        const filterEvents = () => {
            const period = document.querySelector(CONFIG.selectors.filters.period).value;
            const tier = document.querySelector(CONFIG.selectors.filters.tier).value;
            const region = document.querySelector(CONFIG.selectors.filters.region).value;

            return appState.events.filter(e => {
                if (period === 'ancient' && e.period.start > 500) return false;
                if (period === 'colonial' && (e.period.start < 1500 || e.period.start >= 1900)) return false;
                if (period === 'modern' && e.period.start < 1900) return false;
                if (tier !== 'all' && e.analysis.tier !== tier) return false;
                if (region !== 'all' && !e.geography.region.includes(region)) return false;
                return true;
            });
        };

        const updateChart = (events) => {
            const chartData = events.map(e => ({
                x: Math.max(1, e.metrics.mortality.max),
                y: e.metrics.scores.systematic_intensity,
                label: e.name,
                tier: e.analysis.tier,
                raw: e
            }));

            if (!appState.chart) {
                const ctx = document.querySelector(CONFIG.selectors.chart).getContext('2d');
                appState.chart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            data: chartData,
                            backgroundColor: (ctx) => getTierColor(ctx.raw?.tier || ''),
                            pointRadius: 8,
                            pointHoverRadius: 12,
                            borderWidth: 1,
                            borderColor: 'rgba(255,255,255,0.2)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.raw.label,
                                    afterLabel: (ctx) => [
                                        `Deaths: ${formatNumber(ctx.raw.raw.metrics.mortality.max)}`,
                                        `Intensity: ${ctx.raw.y}%`,
                                        `Type: ${ctx.raw.tier}`
                                    ]
                                },
                                padding: 12,
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                type: 'logarithmic',
                                title: { display: true, text: 'Max Mortality (Log Scale)', color: '#94a3b8' },
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            },
                            y: {
                                min: 0, max: 105,
                                title: { display: true, text: 'Systematic Intensity (%)', color: '#94a3b8' },
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            } else {
                appState.chart.data.datasets[0].data = chartData;
                appState.chart.update();
            }
        };

        const render = () => {
            const filteredEvents = filterEvents();
            
            // Render Chart
            updateChart(filteredEvents);

            // Render Cards
            const container = document.querySelector(CONFIG.selectors.list);
            if (filteredEvents.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary); grid-column:1/-1; text-align:center">No events match criteria.</p>';
            } else {
                // Sort by deaths descending
                const sorted = [...filteredEvents].sort((a,b) => b.metrics.mortality.max - a.metrics.mortality.max);
                container.innerHTML = sorted.map(EventCard).join('');
            }
        };

        const downloadDataset = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState.events, null, 2));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "hpi_dataset.json";
            a.click();
        };

        // --- Initialization ---
        const init = async () => {
            try {
                appState.events = await fetchEvents();
                
                // Attach Event Listeners
                Object.values(CONFIG.selectors.filters).forEach(sel => {
                    document.querySelector(sel).addEventListener('change', render);
                });
                document.querySelector(CONFIG.selectors.download).addEventListener('click', downloadDataset);

                // Initial Render
                render();
            } catch (e) {
                const errEl = document.querySelector(CONFIG.selectors.error);
                errEl.textContent = `System Error: ${e.message}`;
                errEl.style.display = 'block';
                console.error(e);
            }
        };

        // Start App
        init();

    </script>
</body>
</html>
