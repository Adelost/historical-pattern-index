<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPI - Historical Pattern Index</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- App Styles -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- App init (must run before Alpine) -->
    <script type="module">
        import { initApp } from './src/app/main.js';

        document.addEventListener('alpine:init', () => {
            initApp(window.Alpine);
        });

        document.addEventListener('alpine:initialized', () => {
            window.Alpine.store('hpi').init();
        });
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.14.3/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>

    <style>
        /* Hide Alpine elements until loaded */
        [x-cloak] { display: none !important; }
    </style>
</head>
<body>

    <!-- Scrollytelling Intro (vanilla JS, unchanged) -->
    <div id="intro" class="intro">
        <button id="skipIntro" class="skip-intro">Skip intro</button>
        <div class="intro-section visible" data-step="1">
            <p class="intro-text">The deadliest conflict since World War II killed <span class="highlight">5.4 million</span> people.</p>
        </div>
        <div class="intro-section" data-step="2">
            <p class="intro-text">It's not Iraq.<br>Not Syria.<br>Not Afghanistan.</p>
        </div>
        <div class="intro-section" data-step="3">
            <p class="intro-text">It's the <span class="highlight">Second Congo War</span><br><span class="intro-small">(1998–2003)</span></p>
            <p class="intro-subtext">Most people have never heard of it.</p>
        </div>
        <div class="intro-section" data-step="4">
            <p class="intro-tagline">History remembers the winners.</p>
            <p class="intro-tagline">Data remembers the dead.</p>
        </div>
        <div class="intro-section intro-final" data-step="5">
            <button id="enterSite" class="intro-cta">Explore the data</button>
            <p class="intro-skip">↓ Scroll to continue</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content" x-data x-cloak>
        <header>
            <h1>Historical Pattern Index</h1>
            <div class="subtitle">Quantifying systemic mechanics of mass mortality and cultural erasure</div>
        </header>

        <main>
            <!-- Stats Cards -->
            <div class="insights" x-data="statsDisplay()">
                <div class="insight-card" data-variant="primary">
                    <div class="number" x-text="$store.hpi.loading ? '--' : stats.count"></div>
                    <div class="label">Documented Events</div>
                </div>
                <div class="insight-card" data-variant="maroon">
                    <div class="number" x-text="$store.hpi.loading ? '--' : formattedDeaths"></div>
                    <div class="label">Estimated Deaths</div>
                </div>
                <div class="insight-card" data-variant="teal">
                    <div class="number" x-text="$store.hpi.loading ? '--' : formattedYears"></div>
                    <div class="label">Years of History</div>
                </div>
                <div class="insight-card highlight" data-variant="danger">
                    <div class="number" x-text="$store.hpi.loading ? '--' : stats.denied"></div>
                    <div class="label">Still Officially Denied</div>
                </div>
            </div>

            <!-- View Tabs -->
            <div class="view-tabs">
                <button class="tab"
                        :class="{ 'active': $store.hpi.currentView === 'main' }"
                        @click="$store.hpi.switchView('main')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                    Events
                </button>
                <button class="tab"
                        :class="{ 'active': $store.hpi.currentView === 'chart' }"
                        @click="$store.hpi.switchView('chart')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>
                    Chart
                </button>
                <button class="tab"
                        :class="{ 'active': $store.hpi.currentView === 'knowledge' }"
                        @click="$store.hpi.switchView('knowledge')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
                    Knowledge Lost
                </button>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <!-- Events Search -->
                <div class="filter-section search-section"
                     x-show="$store.hpi.currentView === 'main' || $store.hpi.currentView === 'chart'">
                    <div class="search-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="search"
                               class="search-input"
                               placeholder="Search events..."
                               :value="$store.hpi.search"
                               @input.debounce.300ms="$store.hpi.setSearch($event.target.value)"
                               aria-label="Search events">
                    </div>
                </div>

                <!-- Knowledge Search -->
                <div class="filter-section search-section"
                     x-show="$store.hpi.currentView === 'knowledge'">
                    <div class="search-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="search"
                               class="search-input"
                               placeholder="Search knowledge..."
                               :value="$store.hpi.knowledgeSearch"
                               @input.debounce.300ms="$store.hpi.setKnowledgeSearch($event.target.value)"
                               aria-label="Search knowledge">
                    </div>
                </div>

                <!-- Tier Filters -->
                <div class="filter-section"
                     x-show="$store.hpi.currentView === 'main' || $store.hpi.currentView === 'chart'"
                     x-data="{ tiers: HPI.getTierOptions() }">
                    <div class="pill-group">
                        <template x-for="tier in tiers" :key="tier.value">
                            <button class="pill"
                                    :data-variant="tier.variant"
                                    :data-active="$store.hpi.filters.tier === tier.value"
                                    @click="$store.hpi.setFilter('tier', tier.value)"
                                    x-text="tier.label">
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Driver Filters (Knowledge) -->
                <div class="filter-section"
                     x-show="$store.hpi.currentView === 'knowledge'"
                     x-data="{ drivers: HPI.getDriverOptions() }">
                    <div class="pill-group">
                        <template x-for="driver in drivers" :key="driver.value">
                            <button class="pill"
                                    :data-variant="driver.variant"
                                    :data-active="$store.hpi.knowledgeDriver === driver.value"
                                    @click="$store.hpi.setKnowledgeDriver(driver.value)"
                                    x-text="driver.label">
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Denial Filter -->
                <div class="filter-section"
                     x-show="$store.hpi.currentView === 'main' || $store.hpi.currentView === 'chart'">
                    <select class="control-input control-small"
                            aria-label="Filter by Denial Status"
                            :value="$store.hpi.filters.denial"
                            @change="$store.hpi.setFilter('denial', $event.target.value)">
                        <option value="all">Denial: All</option>
                        <option value="denied">Denied</option>
                        <option value="partial">Partial</option>
                        <option value="acknowledged">Acknowledged</option>
                    </select>
                </div>

                <!-- Download -->
                <button class="btn-download"
                        title="Download JSON"
                        @click="(() => {
                            const blob = new Blob([JSON.stringify($store.hpi.events, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url; a.download = 'hpi_dataset.json'; a.click();
                        })()">
                    Export
                </button>
            </div>

            <!-- Main View: Events -->
            <div class="view" :class="{ 'active': $store.hpi.currentView === 'main' }">
                <div class="view-content">
                    <!-- Timeline -->
                    <div class="events-section">
                        <div class="section-header">
                            <h3>Timeline</h3>
                            <span class="events-count" x-text="$store.hpi.filteredEvents.length + ' events'"></span>
                        </div>
                        <div class="timeline-container">
                            <div class="timeline"
                                 x-data="timeline({
                                     items: $store.hpi.filteredEvents,
                                     getId: (e) => e.id,
                                     getX: (e, i, total) => total > 1 ? (i / (total - 1)) * 100 : 50,
                                     getColor: (e) => HPI.getTier(e.analysis?.tier).color,
                                     getLabel: (e) => HPI.getShortName(e),
                                     getYear: (e) => e.period?.start,
                                     onSelect: (id) => $store.hpi.toggleEvent(id)
                                 })"
                                 x-effect="selectedId = $store.hpi.selectedEvent">
                                <div class="timeline-axis"></div>
                                <template x-for="(event, index) in sortedItems" :key="getId(event)">
                                    <div>
                                        <span class="timeline-year"
                                              :style="`left: ${getDotX(event, index)}%`"
                                              x-text="getYear(event)"></span>
                                        <div class="timeline-dot"
                                             :style="getDotStyle(event, index)"
                                             :data-active="isSelected(event)"
                                             @click="select(event)"
                                             @mouseenter="hover(event)"
                                             @mouseleave="hover(null)">
                                        </div>
                                        <span class="timeline-label"
                                              :style="`left: ${getDotX(event, index)}%`"
                                              x-text="getLabel(event)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Event Table -->
                    <div class="event-table" role="grid" aria-label="Historical events">
                        <!-- Loading State -->
                        <template x-if="$store.hpi.loading">
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Loading historical data...</span>
                            </div>
                        </template>

                        <!-- Table Content -->
                        <template x-if="!$store.hpi.loading">
                            <div x-data="dataTable({
                                     columns: [
                                         { key: 'tier', label: '', width: '40px', sortable: false },
                                         { key: 'name', label: 'Event', sortable: true },
                                         { key: 'period', label: 'Period', width: '120px', sortable: true,
                                           sortFn: (a, b) => a.period.start - b.period.start },
                                         { key: 'deaths', label: 'Deaths', width: '100px', sortable: true,
                                           sortFn: (a, b) => (a.metrics?.mortality?.max || 0) - (b.metrics?.mortality?.max || 0) },
                                         { key: 'index', label: 'Index', width: '80px', sortable: true,
                                           sortFn: (a, b) => HPI.calcIndex(a) - HPI.calcIndex(b) }
                                     ],
                                     data: $store.hpi.filteredEvents,
                                     expandable: true,
                                     getId: (e) => e.id,
                                     rowStyle: (e) => ({ '--tier-color': HPI.getTier(e.analysis?.tier).color }),
                                     defaultSort: { field: $store.hpi.sort.field, dir: $store.hpi.sort.direction },
                                     onSortChange: (s) => $store.hpi.setSort(s.field)
                                 })"
                                 x-effect="expandedId = $store.hpi.selectedEvent; sortField = $store.hpi.sort.field; sortDir = $store.hpi.sort.direction"

                                <!-- Header -->
                                <div class="table-header">
                                    <template x-for="col in columns" :key="col.key">
                                        <div class="table-cell"
                                             :class="'cell-' + col.key"
                                             :style="col.width ? `width: ${col.width}` : ''"
                                             :data-sortable="col.sortable"
                                             :data-sort-active="isSortActive(col.key)"
                                             :data-sort-dir="getSortDir(col.key)"
                                             @click="col.sortable && sort(col.key)">
                                            <span x-text="col.label"></span>
                                            <svg x-show="col.sortable" class="sort-icon" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M7 10l5 5 5-5z"/>
                                            </svg>
                                        </div>
                                    </template>
                                    <div class="table-cell cell-expand" style="width: 80px"></div>
                                </div>

                                <!-- Rows -->
                                <template x-for="event in sortedData" :key="getId(event)">
                                    <div>
                                        <!-- Row -->
                                        <div class="table-row expandable-row"
                                             :class="{ 'expanded': isExpanded(event) }"
                                             :style="getRowStyles(event)"
                                             @click="$store.hpi.toggleEvent(getId(event))">
                                            <div class="table-cell cell-tier">
                                                <span class="tier-dot"></span>
                                            </div>
                                            <div class="table-cell cell-name">
                                                <span class="event-name" x-text="event.name"></span>
                                                <span class="event-meta">
                                                    <span class="tier-label" x-text="HPI.getTier(event.analysis?.tier).shortLabel"></span>
                                                    <span x-show="event.denial_status === 'denied'" class="denied-tag">DENIED</span>
                                                </span>
                                            </div>
                                            <div class="table-cell cell-period" x-text="HPI.formatPeriod(event)"></div>
                                            <div class="table-cell cell-deaths" x-text="HPI.formatEventDeaths(event)"></div>
                                            <div class="table-cell cell-index" x-text="HPI.formatIndex(event)"></div>
                                            <div class="table-cell cell-expand">
                                                <span class="expand-hint">Details</span>
                                                <svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M7 10l5 5 5-5z"/>
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Expanded Details -->
                                        <div class="table-row-details expandable-row-details"
                                             :class="{ 'expanded': isExpanded(event) }"
                                             x-show="isExpanded(event)"
                                             x-collapse
                                             x-data="eventDetails(event)">
                                            <div class="details-inner">
                                                <!-- Description -->
                                                <template x-if="event.description">
                                                    <div class="colored-section" :style="`--section-color: ${tier.color}`">
                                                        <p x-text="event.description"></p>
                                                    </div>
                                                </template>

                                                <!-- Participants -->
                                                <template x-if="perpetrators.length || victims.length">
                                                    <div class="participants-section">
                                                        <template x-if="perpetrators.length">
                                                            <div class="participants-row perpetrators">
                                                                <span class="participants-label">Perpetrators:</span>
                                                                <template x-for="p in perpetrators" :key="p">
                                                                    <span class="participant-chip" x-text="p"></span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        <template x-if="victims.length">
                                                            <div class="participants-row victims">
                                                                <span class="participants-label">Victims:</span>
                                                                <template x-for="v in victims" :key="v">
                                                                    <span class="participant-chip" x-text="v"></span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>

                                                <!-- Scores -->
                                                <div class="scores-section">
                                                    <template x-for="score in scores" :key="score.key">
                                                        <div class="score-row" x-data="{ expanded: false }">
                                                            <div class="score-row-header" @click="expanded = !expanded">
                                                                <span class="score-label" x-text="score.label"></span>
                                                                <div class="score-bar-wrap">
                                                                    <div class="score-bar">
                                                                        <div class="score-fill"
                                                                             :class="score.type"
                                                                             :style="`width: ${score.value}%`"></div>
                                                                    </div>
                                                                    <span class="score-value" x-text="score.value + '%'"></span>
                                                                </div>
                                                                <svg x-show="score.breakdown" class="score-expand-icon" :class="{ 'rotated': expanded }" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                                                </svg>
                                                            </div>
                                                            <div class="score-breakdown" x-show="expanded && score.breakdown" x-collapse>
                                                                <p class="score-description" x-text="score.description"></p>
                                                                <div class="breakdown-chips">
                                                                    <template x-for="item in score.breakdown?.items || []" :key="item.key">
                                                                        <span class="breakdown-chip"
                                                                              :class="{ 'checked': item.checked }"
                                                                              x-text="(item.checked ? '✓ ' : '✗ ') + item.label">
                                                                        </span>
                                                                    </template>
                                                                </div>
                                                                <template x-if="score.rationale">
                                                                    <p class="breakdown-rationale" x-text="score.rationale"></p>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>

                                                <!-- Linked Knowledge -->
                                                <template x-if="linkedKnowledge.length">
                                                    <div class="linked-knowledge">
                                                        <h4>Linked Knowledge</h4>
                                                        <template x-for="k in linkedKnowledge" :key="k.id">
                                                            <div class="knowledge-link-chip"
                                                                 :class="{ 'saved': k.isSaved }"
                                                                 @click="$store.hpi.switchView('knowledge')">
                                                                <span x-text="k.name"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>

                                                <!-- Sources -->
                                                <template x-if="sources.length">
                                                    <div class="sources-section">
                                                        <h4>Sources</h4>
                                                        <ul>
                                                            <template x-for="source in sources" :key="source.title">
                                                                <li x-text="`${source.author} (${source.year}). ${source.title}`"></li>
                                                            </template>
                                                        </ul>
                                                        <template x-if="wikiUrl">
                                                            <a :href="wikiUrl" target="_blank" class="wiki-link">Wikipedia →</a>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Empty State -->
                                <template x-if="sortedData.length === 0 && !$store.hpi.loading">
                                    <div class="table-empty">
                                        No events match your filters.
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Chart View -->
            <div class="view" :class="{ 'active': $store.hpi.currentView === 'chart' }">
                <div class="chart-modes">
                    <button class="tab"
                            :class="{ 'active': $store.hpi.chartMode === 'systematic' }"
                            @click="$store.hpi.setChartMode('systematic')">
                        Deaths vs Systematic
                    </button>
                    <button class="tab"
                            :class="{ 'active': $store.hpi.chartMode === 'driver' }"
                            @click="$store.hpi.setChartMode('driver')">
                        Profit vs Ideology
                    </button>
                </div>
                <div class="chart-wrapper" id="chartContainer">
                    <!-- Chart will be rendered by chart.js -->
                </div>
            </div>

            <!-- Knowledge View -->
            <div class="view" :class="{ 'active': $store.hpi.currentView === 'knowledge' }">
                <div class="knowledge-container view-content">
                    <!-- Lost Section -->
                    <div class="knowledge-section">
                        <div class="section-header">
                            <h3>Lost</h3>
                            <span class="knowledge-count" x-text="$store.hpi.sortedKnowledgeLost.length"></span>
                        </div>
                        <div class="knowledge-cards">
                            <template x-for="entry in $store.hpi.sortedKnowledgeLost" :key="entry.id">
                                <div class="table-row"
                                     :style="`--tier-color: ${HPI.getDriver(entry.driver).color}`"
                                     x-data="knowledgeDetails(entry, false)">
                                    <div class="table-cell cell-tier">
                                        <span class="tier-dot"></span>
                                    </div>
                                    <div class="table-cell cell-name">
                                        <span class="event-name" x-text="entry.name"></span>
                                        <span class="event-meta">
                                            <span class="tier-label" x-text="driver.label"></span>
                                        </span>
                                    </div>
                                    <div class="table-cell cell-period" x-text="formattedYear"></div>
                                    <div class="table-cell cell-deaths">Lost</div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Saved Section -->
                    <div class="knowledge-section">
                        <div class="section-header">
                            <h3>Saved</h3>
                            <span class="knowledge-count saved" x-text="$store.hpi.sortedKnowledgeSaved.length"></span>
                        </div>
                        <div class="knowledge-cards">
                            <template x-for="entry in $store.hpi.sortedKnowledgeSaved" :key="entry.id">
                                <div class="table-row"
                                     :style="`--tier-color: ${HPI.getDriver(entry.driver).color}`"
                                     x-data="knowledgeDetails(entry, true)">
                                    <div class="table-cell cell-tier">
                                        <span class="tier-dot"></span>
                                    </div>
                                    <div class="table-cell cell-name">
                                        <span class="event-name" x-text="entry.name"></span>
                                        <span class="event-meta">
                                            <span class="tier-label" x-text="driver.label"></span>
                                        </span>
                                    </div>
                                    <div class="table-cell cell-period" x-text="formattedYear"></div>
                                    <div class="table-cell cell-deaths saved-text">Rescued</div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Open-source project. <a href="https://github.com/adelost/historical-pattern-index">GitHub</a> · <a href="https://github.com/adelost/historical-pattern-index/blob/master/METHODOLOGY.md">Methodology</a></p>
            <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--ctp-overlay0);">Data remembers what narrative forgets.</p>
        </footer>
    </div>

    <!-- Intro Script (unchanged) -->
    <script>
        (function() {
            const hasSeenIntro = localStorage.getItem('hpi-intro-seen');
            const intro = document.getElementById('intro');
            const mainContent = document.getElementById('mainContent');

            if (hasSeenIntro) {
                intro.classList.add('hidden');
                mainContent.classList.add('visible');
                return;
            }

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.5 });

            document.querySelectorAll('.intro-section').forEach(section => {
                observer.observe(section);
            });

            document.getElementById('enterSite').addEventListener('click', enterSite);
            document.getElementById('skipIntro').addEventListener('click', enterSite);

            function enterSite() {
                localStorage.setItem('hpi-intro-seen', 'true');
                intro.style.opacity = '0';
                intro.style.transition = 'opacity 0.5s ease';

                setTimeout(() => {
                    intro.classList.add('hidden');
                    mainContent.classList.add('visible');
                    window.scrollTo(0, 0);
                }, 500);
            }

            let scrolledPast = false;
            window.addEventListener('scroll', () => {
                const introRect = intro.getBoundingClientRect();
                if (introRect.bottom < 0 && !scrolledPast) {
                    scrolledPast = true;
                    enterSite();
                }
            });
        })();
    </script>

</body>
</html>
